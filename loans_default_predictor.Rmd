---
title: "Predictive Modelling for Loans"
output: html_notebook
---
```{r}
library('readxl')
library('tidyverse')
library('janitor')
library('GGally')
```

```{r}
library(readr)
lending_club_loans <- read_csv("C:/Users/44792/OneDrive/Desktop/Codeclan 2022/final_project_loan_default_predictor/data/lending_club_loans.csv")
View(lending_club_loans)
```
## Background
#Lending Club was established in 2007 and there are now over 4 million members. It is a #peer-to-peer lender and the first in the USA to register its offering as securities #with SEC (Securities and Exchange Commission).
#Lending Club, or other P2 P lenders, intersects technology and finance and with this #approach there is the possibility of progress a more effective business model and using #machine learning to develop a risk management model that can eliminate lending #bias(introduced by humans).  This data and subsequent model is a good example of how DDD #(Data Driven Decisions) can be used to ensure there is a more transparent approach to #accessing personal finance.

# Ethical consideration in the development of Machine Learning Models

#When gathering data consumer data protection needs to be considered and respected.
#Secondly, when considering the use of machine learning it is important to be transparent #about the use of machine learning during the decision-making process- as noted in annual #reports from LC marketing materials are clear that the company use over 150million cells #of data to support the use of artificial intelligence-driven credit decisions and #machine learning models are being used across the customer lifecycle to expand access to #credit
#Diversity and inclusion in the development of a model is also important as bias can be #introduced if the machine learning models are limited by the data that is gets to train #on.  Developing a team with a wide range of experience and from a diverse range of #backgrounds is important.

#I would recommend that further work be done on some of the new test models “What If” by Google so that the models can be challenged using a number of other inputs.


##Data Preparation and Cleaning
```{r}
view(lending_club_loans)
lending_club_loans <- clean_names(lending_club_loans)

```
```{r}
loans1 <- lending_club_loans %>%
  select(loan_amnt,term,int_rate,sub_grade,home_ownership,annual_inc,purpose, loan_status)
```


#View the structure of the data
```{r}
glimpse(loans1)
```
```{r}
str(loans1)
```


```{r}
summary(loans1)
```


```{r}
loans2 <- loans1 %>%
  filter(!is.na(loan_amnt))
loans2

loans3 <- loans2 %>%
  filter(!is.na(annual_inc))

```


```{r}
summary(as.factor(loans2$term))
```
#Majority of the loans are for 36 months (74%) and 26% and for 60 months.

```{r}
summary(as.factor(loans2$sub_grade))
```
#LC grade the loans A1 to G5 with A being the least likely to default and G5 the catergory with the highest risk profile.

```{r}
summary(as.factor(loans2$purpose))
```
#Debt consolidation (19,776 loans) 46% of loans followed by paying off credit card debt (5,477) 13% and then other (4425) 10% are the top three purposes of the loan request. It should be noted that this is self reported by the applicant and caution should be exercised when considering the validity of this informations.

```{r}
summary(as.factor(loans2$loan_status))
```


```{r}
glimpse(loans3)
```
#Further cleaning of the data here at this point to 

## Explority analysis

##Before building a model i think it is important to consider the key characteristics of a loan that has been defaulted on so that we are in a stronger position to understand what are the strong predictors of a  loan defaulting.


#Visual and explore the characteristics of the defaults loans only to uderstand more about the type of loan that is written off.

```{r}
default1 <-loans3 %>%
  filter(loan_status == "Charged Off")
```


```{r}
glimpse(default1)
```
```{r}
summary(default1)
```
#Average value of the defaulted loan is $12,134


```{r}
default1 %>%
  group_by(term, term_count = n())
```


```{r}
default_arranged <- default1 %>%
  select(loan_amnt, term)%>%
  arrange(desc(loan_amnt))
```

```{r}
summary(default_arranged)
```
#Data set for default loans is 5,653 and on average the default is $12,134 - across the business and the timeline of the data this could be a value of $68,593,502 so any reduction in the number of defaulting loans by 1% would be $68,000 additional revenue.


```{r}
ggplot(default1) +
  geom_bar(aes(x= term), fill = "light blue")+
labs( x= "Term of Loan",
        y= "Number of Default Loans",
        title = "Lending Club Default Loans Data")
```


# Loans with the longer term of 60 months make up a higher percentage of the defaults loans ?? - so we could conclude that the longer the term the higher the exposure to changes in a persons financial status.


```{r}
ggplot(default1) +
  geom_bar(aes(x=home_ownership), fill = "light blue")+
   labs( x= "Houseing Status",
        y= "Number of Default Loans",
        title = "Lending Club Loans Data",
        subtitle = "Houseing Status")
```
#Default loans also have a higher percentage of renters - unsurprising and also might be considered a higher risk when lending as a credit check cannot be secured from the other lender.


```{r}
ggplot(default1) +
  geom_bar(aes(x= term, fill = purpose))+
  labs( x= "Term of Default Loan",
        y= "Number of Default Loans",
        title = "Lending Club Default Loans Data",
        subtitle = "Term & Purpose",
        fill = "Purpose of Loan")
```
#Debt consolidation, payment of credit card debts and "other" continue to be the top three reasons for a loan and defaults.  Limiting exposure to the loans being used for this purpose may be a consideration in the future.


```{r}
ggplot(default1) + 
  aes(x = int_rate, y = term) +
  geom_point(aes(colour = sub_grade, shape = purpose), size = 4) +
  geom_text(
    aes(label = purpose),
    nudge_x = 0.5,
    nudge_y = 0.1,)
  
```
```{r}
ggplot(default1) +
  geom_bar(aes(x= int_rate, fill = term))+
  labs( x= "Interest Rate",
        y= "Number of Default Loans",
        title = "Lending Club Default Loans Data",
        subtitle = "Term & Purpose",
        fill = "Term")
```
XX rubbish plot - may chuck



  

```{r}
ggplot(default1) +
  geom_bar(aes(x= term, fill = annual_inc))+
  labs( x= "Term of Default Loan",
        y= "Number of Default Loans",
        title = "Lending Club Default Loans Data",
        subtitle = "Term & Purpose",
        fill = "Purpose of Loan")
```




```{r}
loansstatusnew <- loans3 %>%
  group_by(loan_status)
count(loansstatusnew)
```
#Total of 42,531 individual loan accounts with 5,653 charged off (meaning that the lender has written off the debt and the account is closed) 
#(13% of the total loans made) - so a reduction in the defualts of 1% (is across this data the average losses were $68m - this )

#Total of 33,586 fully paid (79% of the total loans)
#From the data set there are some records that are unclear catergories






```{r}
ggplot(loansstatusnew) +
  geom_bar(aes(x= loan_status), fill = "light blue")+
  coord_flip()+
labs( x= "Status of Loan",
        y= "Number of Loans",
        title = "Lending Club Loans Data",
        subtitle = "Status of Loan")
```





#loan status needs to be turned into a numerical column 0 or 1 for purpose of building a predictive model.





```{r}
loans4 <-loans3 %>%
  mutate(loan_status = recode(loan_status,"Fully Paid" = "1", "Charged Off" = "0")) 
loans4
```


```{r}
loans4 <-loans3 %>%
  mutate(loan_status = recode(loan_status,"Fully Paid" = "1", "Charged Off" = "0"))
filter(loans)
loans4
```




loans4 <-loans3 %>%
  mutate(loan_status = recode(loan_status,"Fully Paid" = "1", "Charged Off" = "0")) 
loans4
```{r}
glimpse(loans4)
```



```{r}
head(loans4, 15)
```


```{r}
ggplot(loans4) +
  geom_bar(aes(x= term), fill = "light blue")+
labs( x= "Term of Loan",
        y= "Number of Loans",
        title = "Lending Club Loans Data")
```


```{r}
ggplot(loans4) +
  geom_bar(aes(x= loan_status), fill = "light blue")+
  coord_flip()+
labs( x= "Status of Loan",
        y= "Number of Loans",
        title = "Lending Club Loans Data")
```
dump this....

```{r}
ggplot(loans4) +
  geom_bar(aes(x=home_ownership), fill = "light blue")+
   labs( x= "Houseing Status",
        y= "Number of Loans",
        title = "Lending Club Loans Data",
        subtitle = "Houseing Status")
```


```{r}
ggplot(loans4) +
  geom_bar(aes(x= term, fill = purpose))+
  labs( x= "Term of Loan",
        y= "Number of Loans",
        title = "Lending Club Loans Data",
        subtitle = "Term & Purpose",
        fill = "Purpose of Loan")
```
#More debt consolidation - so we could consdier that an application for such a matter could have a higher risk that for medical bills or buying a car.




#Machine Model



#Now let's have a look at the relationships with loan status. I will split the variables into three sets, as the output of `ggpairs()` will be slow and cramped if we include all variables at once. Note that a disadvantage of this approach is that it will be difficult to visually assess relationships between some predictor pairs if they fall into different split sets.


```{r}
loans_split1 <- loans4 %>%
  select(loan_amnt, term,home_ownership, loan_status)
```


```{r}
loans_split2 <- loans4 %>%
  select(annual_inc, purpose,loan_status)
```

#Now develop the connection with ggpairs

```{r}
library(GGally)
loans_split1 %>%
  ggpairs()
```

```{r}
library(GGally)
loans_split2 %>%
  ggpairs()
```









